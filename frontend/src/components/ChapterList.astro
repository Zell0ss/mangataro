---
import type { Chapter } from '../lib/api';
import { formatTimeAgo } from '../lib/utils';

interface Props {
  chapters: Chapter[];
}

const { chapters } = Astro.props;

// Prepare chapter data for Alpine.js
const chapterData = chapters.map(ch => ({
  id: ch.id,
  number: parseFloat(ch.chapter_number),
  read: ch.read
}));
---

<script is:inline define:vars={{ chapterData }}>
  window.chapterData = chapterData;
</script>

<div class="divide-y divide-ink-700/30" x-data="{
  readChapters: new Set(window.chapterData.filter(ch => ch.read).map(ch => ch.id)),
  allChapters: window.chapterData,

  markAsRead(chapterId, cascade = true) {
    this.readChapters.add(chapterId);
    fetch(window.__API_BASE + '/api/tracking/chapters/' + chapterId + '/mark-read', { method: 'PUT' })
      .then(res => res.json())
      .then(() => console.log('Marked chapter ' + chapterId + ' as read'));

    if (cascade) {
      const currentChapter = this.allChapters.find(ch => ch.id === chapterId);
      if (currentChapter) {
        const previousChapters = this.allChapters.filter(ch => ch.number < currentChapter.number);
        console.log('Cascade marking ' + previousChapters.length + ' previous chapters');
        previousChapters.forEach(ch => {
          if (!this.readChapters.has(ch.id)) {
            this.readChapters.add(ch.id);
            fetch(window.__API_BASE + '/api/tracking/chapters/' + ch.id + '/mark-read', { method: 'PUT' });
          }
        });
      }
    }
  },

  markAsUnread(chapterId) {
    this.readChapters.delete(chapterId);
    fetch(window.__API_BASE + '/api/tracking/chapters/' + chapterId + '/mark-unread', { method: 'PUT' })
      .then(res => res.json())
      .then(() => console.log('Marked chapter ' + chapterId + ' as unread'));
  }
}">
  {chapters.map((chapter) => (
    <div
      class="flex items-center gap-4 px-5 py-3 hover:bg-ink-700/20 transition-colors duration-150 group"
      :class={`readChapters.has(${chapter.id}) && 'opacity-35'`}
    >
      <!-- Checkbox -->
      <label class="flex items-center cursor-pointer flex-shrink-0">
        <input
          type="checkbox"
          :checked={`readChapters.has(${chapter.id}) || ${chapter.read}`}
          @change={`$event.target.checked ? markAsRead(${chapter.id}) : markAsUnread(${chapter.id})`}
          class="w-4 h-4 rounded border-ink-600 bg-ink-800 text-crimson-600 focus:ring-crimson-600/50 focus:ring-offset-0 focus:ring-1 cursor-pointer"
        />
      </label>

      <!-- Chapter Number -->
      <a
        href={chapter.chapter_url}
        target="_blank"
        rel="noopener noreferrer"
        class="text-sm font-semibold text-crimson-400 hover:text-crimson-300 transition flex-shrink-0 w-16"
      >
        Ch. {chapter.chapter_number}
      </a>

      <!-- Title -->
      <div class="flex-1 min-w-0">
        {chapter.chapter_title && (
          <span class="text-sm text-ink-200 line-clamp-1">{chapter.chapter_title}</span>
        )}
      </div>

      <!-- Metadata -->
      <div class="flex items-center gap-1.5 text-xs text-ink-500 flex-shrink-0">
        <span class="text-ink-400">{chapter.manga_scanlator.scanlator.name}</span>
        <span class="text-ink-600">&middot;</span>
        <span>{formatTimeAgo(chapter.detected_date)}</span>
      </div>
    </div>
  ))}
</div>
