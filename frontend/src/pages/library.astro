---
import Layout from '../layouts/Layout.astro';
import MangaCard from '../components/MangaCard.astro';
import { api } from '../lib/api';

let allManga = [];
let error = null;

try {
  allManga = await api.getAllManga();
} catch (e) {
  console.error('Failed to fetch manga:', e);
  error = e.message;
}
---

<Layout title="Library - MangaTaro">
  <div>
    {error ? (
      <div class="text-center py-16">
        <p class="text-red-400 text-lg">Failed to load library</p>
        <p class="text-slate-500 text-sm mt-2">{error}</p>
      </div>
    ) : (
      <>
        <!-- Header with Search -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-slate-100">Library</h1>
          <p class="text-slate-400 mt-2">{allManga.length} manga in your collection</p>
        </div>

        <!-- Search Bar and Filtering with Alpine.js -->
        <div class="mb-6" x-data="{
          search: '',
          status: 'all',
          isVisible(element) {
            const mangaStatus = element.dataset.mangaStatus;
            const mangaTitle = element.dataset.mangaTitle;
            const statusMatch = this.status === 'all' || this.status === mangaStatus;
            const searchMatch = this.search === '' || mangaTitle.includes(this.search.toLowerCase());
            return statusMatch && searchMatch;
          }
        }">
          <input
            type="text"
            x-model="search"
            placeholder="Search manga..."
            class="w-full max-w-md px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-100"
          />

          <!-- Status Filter Tabs -->
          <div class="flex gap-2 mt-4">
            <button
              @click="status = 'all'"
              :class="status === 'all' ? 'bg-blue-600' : 'bg-slate-800 hover:bg-slate-700'"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              All
            </button>
            <button
              @click="status = 'reading'"
              :class="status === 'reading' ? 'bg-blue-600' : 'bg-slate-800 hover:bg-slate-700'"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              Reading
            </button>
            <button
              @click="status = 'completed'"
              :class="status === 'completed' ? 'bg-blue-600' : 'bg-slate-800 hover:bg-slate-700'"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              Completed
            </button>
            <button
              @click="status = 'on_hold'"
              :class="status === 'on_hold' ? 'bg-blue-600' : 'bg-slate-800 hover:bg-slate-700'"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              On Hold
            </button>
          </div>

          <!-- Manga Grid with MangaCard components -->
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-8">
            {allManga.map((manga) => (
              <div
                x-show="isVisible($el)"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                data-manga-status={manga.status}
                data-manga-title={manga.title.toLowerCase()}
              >
                <MangaCard manga={manga} />
              </div>
            ))}
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
