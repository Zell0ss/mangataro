---
import Layout from '../../layouts/Layout.astro';
import { api } from '../../lib/api';
import { getCoverUrl } from '../../lib/utils';

const scanlatorIdParam = Astro.url.searchParams.get('scanlator');

let scanlators = [];
let selectedScanlator = null;
let unmappedData = null;
let error = null;

try {
  scanlators = await api.getScanlators();

  if (scanlators.length === 0) {
    error = 'No active scanlators found. Please add a scanlator first.';
  } else {
    if (scanlatorIdParam) {
      const requestedId = parseInt(scanlatorIdParam);
      selectedScanlator = scanlators.find(s => s.id === requestedId);
    }

    if (!selectedScanlator) {
      selectedScanlator = scanlators.find(s => s.name === 'AsuraScans') || scanlators[0];
    }

    if (selectedScanlator) {
      unmappedData = await api.getUnmappedManga(selectedScanlator.id);
    }
  }
} catch (e) {
  console.error('Failed to load data:', e);
  error = e.message;
}
---

<Layout title="Map Manga Sources - MangaTaro">
  <div class="max-w-4xl mx-auto">
    <!-- Back -->
    <a href="/library" class="inline-flex items-center gap-1.5 text-ink-400 hover:text-ink-200 mb-8 text-sm font-medium transition group">
      <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      Library
    </a>

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-display font-extrabold tracking-tight text-ink-50">Map Sources</h1>
      <p class="text-ink-400 mt-1 text-sm">Add tracking URLs for manga from different scanlators</p>
    </div>

    {error ? (
      <div class="text-center py-24">
        <p class="text-crimson-400 text-lg font-display font-semibold">{error}</p>
      </div>
    ) : (
      <>
        <!-- Scanlator Selector -->
        <div class="mb-8">
          <label for="scanlator-select" class="block text-xs font-semibold text-ink-400 uppercase tracking-wider mb-2">
            Scanlator
          </label>
          <select
            id="scanlator-select"
            class="w-full max-w-xs px-4 py-2.5 bg-ink-800/80 border border-ink-700/40 rounded-xl focus:outline-none focus:ring-2 focus:ring-crimson-600/40 text-ink-50 text-sm appearance-none cursor-pointer"
            onchange="window.location.href = `/admin/map-sources?scanlator=${this.value}`"
          >
            {scanlators.map((scanlator) => (
              <option
                value={scanlator.id}
                selected={selectedScanlator && scanlator.id === selectedScanlator.id}
              >
                {scanlator.name}
              </option>
            ))}
          </select>
        </div>

        {/* Counter */}
        {unmappedData && unmappedData.count > 0 && (
          <div class="mb-6 flex items-center gap-2">
            <span class="text-sm text-ink-400">
              <span class="font-semibold text-crimson-400">{unmappedData.count}</span> manga need mapping
            </span>
          </div>
        )}

        {/* Empty State */}
        {unmappedData && unmappedData.count === 0 ? (
          <div class="text-center py-20 bg-ink-800/20 rounded-2xl ring-1 ring-ink-700/20">
            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-ink-800/60 ring-1 ring-ink-700/30 flex items-center justify-center">
              <svg class="w-7 h-7 text-ink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <h2 class="text-xl font-display font-extrabold text-ink-50 mb-1">All Mapped</h2>
            <p class="text-ink-400 text-sm">
              Every manga is mapped to {unmappedData.scanlator_name}
            </p>
          </div>
        ) : unmappedData && (
          <div class="space-y-3">
            {unmappedData.unmapped_manga.map((manga) => (
              <div
                x-data={`{
                  url: '',
                  error: '',
                  isSubmitting: false,
                  isValid: false,
                  validateUrl() {
                    this.error = '';
                    if (!this.url) {
                      this.isValid = false;
                      return;
                    }
                    try {
                      const urlObj = new URL(this.url);
                      if (!['http:', 'https:'].includes(urlObj.protocol)) {
                        this.error = 'URL must start with http:// or https://';
                        this.isValid = false;
                        return;
                      }
                    } catch (e) {
                      this.error = 'Invalid URL format';
                      this.isValid = false;
                      return;
                    }
                    const baseUrl = '${unmappedData.base_url || ''}';
                    if (baseUrl && !this.url.includes(baseUrl.replace('https://', '').replace('http://', ''))) {
                      const domain = baseUrl.replace('https://', '').replace('http://', '').replace(/\\/$/, '');
                      this.error = \`URL must be from \${domain}\`;
                      this.isValid = false;
                      return;
                    }
                    this.isValid = true;
                  },
                  async addMapping() {
                    if (!this.isValid || this.isSubmitting) return;
                    this.isSubmitting = true;
                    this.error = '';
                    try {
                      const response = await fetch(window.__API_BASE + '/api/tracking/manga-scanlators', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          manga_id: ${manga.id},
                          scanlator_id: ${selectedScanlator.id},
                          scanlator_manga_url: this.url,
                          manually_verified: true,
                        }),
                      });
                      if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to add mapping');
                      }
                      const row = this.$el;
                      row.style.transition = 'all 0.3s ease-out';
                      row.style.opacity = '0';
                      row.style.transform = 'translateX(-8px)';
                      setTimeout(() => {
                        row.remove();
                        const remainingRows = document.querySelectorAll('[data-manga-row]');
                        if (remainingRows.length === 0) {
                          window.location.reload();
                        }
                      }, 300);
                    } catch (e) {
                      this.error = e.message;
                      this.isSubmitting = false;
                    }
                  }
                }`}
                data-manga-row
                class="bg-ink-800/30 rounded-xl p-4 ring-1 ring-ink-700/20 hover:ring-ink-600/30 transition-all"
              >
                <div class="flex items-start gap-4">
                  <!-- Cover -->
                  <img
                    src={getCoverUrl(manga.cover_filename)}
                    alt={manga.title}
                    class="w-11 h-16 object-cover rounded-lg ring-1 ring-ink-700/50 flex-shrink-0"
                  />

                  <!-- Content -->
                  <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-display font-semibold text-ink-50 mb-2.5">
                      {manga.title}
                    </h3>

                    <!-- URL Input and Button -->
                    <div class="flex gap-2">
                      <input
                        type="text"
                        x-model="url"
                        @blur="validateUrl()"
                        @keydown.enter="addMapping()"
                        placeholder={`Enter ${selectedScanlator.name} URL...`}
                        class="flex-1 px-3 py-2 bg-ink-900/60 border border-ink-700/40 rounded-lg focus:outline-none focus:ring-2 focus:ring-crimson-600/40 text-ink-50 text-sm placeholder:text-ink-600 transition"
                      />
                      <button
                        @click="addMapping()"
                        :disabled="!isValid || isSubmitting"
                        :class="{ 'opacity-40 cursor-not-allowed': !isValid || isSubmitting }"
                        class="px-4 py-2 bg-crimson-600 hover:bg-crimson-500 disabled:hover:bg-crimson-600 text-white rounded-lg font-semibold text-xs transition-all"
                      >
                        <span x-show="!isSubmitting">Add</span>
                        <span x-show="isSubmitting">...</span>
                      </button>
                    </div>

                    <!-- Error -->
                    <p x-show="error" x-text="error" class="mt-2 text-crimson-400 text-xs"></p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </>
    )}
  </div>
</Layout>
