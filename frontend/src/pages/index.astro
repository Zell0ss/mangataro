---
import Layout from '../layouts/Layout.astro';
import ChapterItem from '../components/ChapterItem.astro';
import { api } from '../lib/api';
import { getCoverUrl, formatTimeAgo } from '../lib/utils';

// Fetch both: latest per manga (for grid) and unread (for list)
const [latestChapters, unreadChapters] = await Promise.all([
  api.getLatestChapters(100),
  api.getUnreadChapters(500),
]);

// Count unread per manga
const unreadCountPerManga = new Map<number, number>();
for (const ch of unreadChapters) {
  const mangaId = ch.manga_scanlator.manga.id;
  unreadCountPerManga.set(mangaId, (unreadCountPerManga.get(mangaId) || 0) + 1);
}

const mangaUpdates = latestChapters.map(ch => ({
  chapter: ch,
  manga: ch.manga_scanlator.manga,
  scanlator: ch.manga_scanlator.scanlator,
  unreadCount: unreadCountPerManga.get(ch.manga_scanlator.manga.id) || 0,
}));
---

<Layout title="Updates - MangaTaro">
  <div class="max-w-5xl mx-auto" x-data="{
    mode: 'latest',
    showNSFW: localStorage.getItem('showNSFW') === 'true',
    isVisible(element) {
      const isNSFW = element.dataset.nsfw === 'true';
      const nsfwMatch = this.showNSFW || !isNSFW;
      return nsfwMatch;
    }
  }">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-end justify-between mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-display font-extrabold tracking-tight text-ink-50">Updates</h1>
        <p class="text-ink-400 mt-1 text-sm">
          {unreadChapters.length} unread chapter{unreadChapters.length !== 1 ? 's' : ''} across {mangaUpdates.length} series
        </p>
      </div>

      <!-- Mode Toggle & NSFW Toggle -->
      {mangaUpdates.length > 0 && (
        <div class="flex items-center gap-4">
          <!-- Mode Toggle -->
          <div class="flex bg-ink-800/80 rounded-lg p-1 ring-1 ring-ink-700/40">
            <button
              @click="mode = 'latest'"
              :class="mode === 'latest' ? 'bg-ink-700 text-ink-50 shadow-sm' : 'text-ink-400 hover:text-ink-200'"
              class="px-3.5 py-1.5 text-xs font-semibold rounded-md transition-all duration-200"
            >
              Latest
            </button>
            <button
              @click="mode = 'all'"
              :class="mode === 'all' ? 'bg-ink-700 text-ink-50 shadow-sm' : 'text-ink-400 hover:text-ink-200'"
              class="px-3.5 py-1.5 text-xs font-semibold rounded-md transition-all duration-200"
            >
              All Updates
            </button>
          </div>

          <!-- NSFW Toggle -->
          <div class="flex items-center gap-2">
            <label class="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                class="sr-only peer"
                x-model="showNSFW"
                @change="localStorage.setItem('showNSFW', showNSFW)"
              />
              <div class="w-11 h-6 bg-ink-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-crimson-600/40 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-crimson-600"></div>
              <span class="ml-3 text-sm font-medium text-ink-300">Show NSFW</span>
            </label>
          </div>
        </div>
      )}
    </div>

    {mangaUpdates.length === 0 ? (
      <div class="text-center py-24">
        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-ink-800/60 ring-1 ring-ink-700/30 flex items-center justify-center">
          <svg class="w-7 h-7 text-ink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        </div>
        <p class="text-ink-300 text-lg font-display font-semibold">All caught up</p>
        <p class="text-ink-500 text-sm mt-1">No unread chapters right now</p>
      </div>
    ) : (
      <>
        <!-- Latest per Series View -->
        <div x-show="mode === 'latest'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {mangaUpdates.map(({ chapter, manga, scanlator, unreadCount }) => (
              <a
                href={`/manga/${manga.id}`}
                class="group relative rounded-xl overflow-hidden bg-ink-800 ring-1 ring-ink-700/30 hover:ring-crimson-600/30 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-crimson-950/20"
                x-show="isVisible($el)"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                data-nsfw={manga.nsfw}
              >
                <div class="aspect-[2/3] overflow-hidden">
                  <img
                    src={getCoverUrl(manga.cover_filename)}
                    alt={manga.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-ink-950 via-ink-950/30 to-transparent"></div>
                </div>

                <!-- Unread count badge -->
                <div class="absolute top-2.5 right-2.5 bg-crimson-600 text-white text-[11px] font-bold px-2 py-0.5 rounded-full shadow-lg ring-2 ring-ink-800">
                  {unreadCount}
                </div>

                <!-- Info Overlay -->
                <div class="absolute bottom-0 left-0 right-0 p-3">
                  <h3 class="font-display font-semibold text-ink-50 line-clamp-2 text-sm leading-snug">{manga.title}</h3>
                  <p class="text-crimson-400 text-xs font-semibold mt-1">Ch. {chapter.chapter_number}</p>
                  <p class="text-ink-400 text-[11px] mt-0.5">{formatTimeAgo(chapter.detected_date)}</p>
                </div>
              </a>
            ))}
          </div>
        </div>

        <!-- All Updates View -->
        <div x-show="mode === 'all'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <div class="space-y-2">
            {unreadChapters.map((chapter) => (
              <div
                x-show="isVisible($el)"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                data-nsfw={chapter.manga_scanlator.manga.nsfw}
              >
                <ChapterItem chapter={chapter} />
              </div>
            ))}
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
