---
import Layout from '../../layouts/Layout.astro';
import ChapterList from '../../components/ChapterList.astro';
import { api } from '../../lib/api';
import { getCoverUrl } from '../../lib/utils';

const { id } = Astro.params;
if (!id) return Astro.redirect('/library');

const mangaId = parseInt(id);
if (isNaN(mangaId)) return Astro.redirect('/library');

let manga = null;
let chapters = [];
let scanlators = [];
let error = null;

try {
  manga = await api.getManga(mangaId);
  chapters = await api.getMangaChapters(mangaId);
  scanlators = await api.getScanlators();
} catch (e) {
  console.error('Failed to fetch manga:', e);
  error = e.message;
}

if (!manga && !error) return Astro.redirect('/library');

const unreadCount = chapters.filter(c => !c.read).length;
---

<Layout title={manga ? `${manga.title} - MangaTaro` : 'Error - MangaTaro'}>
  {manga && (
    <script is:inline define:vars={{ mangaId: manga.id, mangaTitle: manga.title, mangaNsfw: manga.nsfw, mangaSources: manga.manga_scanlators, allScanlators: scanlators }}>
      window.__MANGA_DATA__ = {
        id: mangaId,
        title: mangaTitle,
        nsfw: mangaNsfw,
        sources: mangaSources,
        allScanlators: allScanlators
      };
    </script>
  )}
  <div class="max-w-5xl mx-auto" x-data="{
    manga: window.__MANGA_DATA__ || { id: null, title: '', nsfw: false, sources: [], allScanlators: [] },
    sources: window.__MANGA_DATA__?.sources || [],
    allScanlators: window.__MANGA_DATA__?.allScanlators || [],
    newSource: {
      scanlatorId: '',
      url: '',
      error: '',
      isSubmitting: false
    },
    async toggleNSFW() {
      const newValue = !this.manga.nsfw;
      try {
        const response = await fetch(`${window.__API_BASE}/api/manga/${this.manga.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nsfw: newValue })
        });
        if (response.ok) {
          this.manga.nsfw = newValue;
        }
      } catch (error) {
        console.error('Failed to update NSFW flag:', error);
      }
    },
    async removeSource(sourceId) {
      if (!confirm('Remove this scanlator source? Chapters from this source will be deleted.')) return;
      try {
        const response = await fetch(`${window.__API_BASE}/api/tracking/manga-scanlators/${sourceId}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          this.sources = this.sources.filter(s => s.id !== sourceId);
        } else {
          alert('Failed to remove source');
        }
      } catch (error) {
        console.error('Failed to remove source:', error);
        alert('Failed to remove source');
      }
    },
    async addSource() {
      if (this.newSource.isSubmitting) return;
      this.newSource.error = '';

      if (!this.newSource.scanlatorId || !this.newSource.url) {
        this.newSource.error = 'Please select a scanlator and enter a URL';
        return;
      }

      try {
        new URL(this.newSource.url);
      } catch (e) {
        this.newSource.error = 'Invalid URL format';
        return;
      }

      this.newSource.isSubmitting = true;

      try {
        const response = await fetch(`${window.__API_BASE}/api/tracking/manga-scanlators`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            manga_id: this.manga.id,
            scanlator_id: parseInt(this.newSource.scanlatorId),
            scanlator_manga_url: this.newSource.url,
            manually_verified: true
          })
        });

        if (response.ok) {
          const newMapping = await response.json();
          const scanlator = this.allScanlators.find(s => s.id === parseInt(this.newSource.scanlatorId));
          this.sources.push({
            id: newMapping.id,
            scanlator_manga_url: newMapping.scanlator_manga_url,
            scanlator: scanlator
          });
          this.newSource.scanlatorId = '';
          this.newSource.url = '';
        } else {
          const errorData = await response.json();
          this.newSource.error = errorData.detail || 'Failed to add source';
        }
      } catch (error) {
        console.error('Failed to add source:', error);
        this.newSource.error = 'Failed to add source';
      } finally {
        this.newSource.isSubmitting = false;
      }
    },
    get availableScanlators() {
      const usedIds = this.sources.map(s => s.scanlator.id);
      return this.allScanlators.filter(s => !usedIds.includes(s.id));
    }
  }">
    {error ? (
      <div class="text-center py-24">
        <p class="text-crimson-400 text-lg font-display font-semibold">Failed to load manga</p>
        <p class="text-ink-500 text-sm mt-2">{error}</p>
        <a href="/library" class="text-crimson-400 hover:text-crimson-300 mt-4 inline-block text-sm font-medium">&larr; Back to Library</a>
      </div>
    ) : manga ? (
      <>
        <!-- Back -->
        <a href="/library" class="inline-flex items-center gap-1.5 text-ink-400 hover:text-ink-200 mb-8 text-sm font-medium transition group">
          <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          Library
        </a>

        <!-- Hero Section -->
        <div class="relative rounded-2xl overflow-hidden mb-10">
          <!-- Blurred Background Cover -->
          <div class="absolute inset-0">
            <img
              src={getCoverUrl(manga.cover_filename)}
              alt=""
              class="w-full h-full object-cover blur-3xl scale-125 opacity-15"
            />
            <div class="absolute inset-0 bg-ink-950/60"></div>
          </div>

          <!-- Content -->
          <div class="relative grid md:grid-cols-[200px,1fr] gap-8 p-6 md:p-8">
            <!-- Cover -->
            <div class="mx-auto md:mx-0">
              <img
                src={getCoverUrl(manga.cover_filename)}
                alt={manga.title}
                class="w-44 md:w-full rounded-xl shadow-2xl shadow-ink-950/80 ring-1 ring-ink-50/10"
              />
            </div>

            <!-- Details -->
            <div class="flex flex-col justify-end">
              <div class="flex items-center gap-3 mb-2">
                <p class="text-crimson-400 text-xs font-semibold tracking-widest uppercase">
                  {manga.status.replace('_', ' ')}
                </p>
                <!-- NSFW Toggle Button -->
                <button
                  @click="toggleNSFW()"
                  :class="manga.nsfw ? 'bg-crimson-600 text-white ring-2 ring-crimson-500' : 'bg-ink-800 text-ink-300 ring-1 ring-ink-700'"
                  class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-200 hover:opacity-90"
                >
                  <span x-show="!manga.nsfw">Mark as NSFW</span>
                  <span x-show="manga.nsfw">NSFW</span>
                </button>
              </div>
              <h1 class="text-3xl md:text-4xl font-display font-extrabold tracking-tight text-ink-50 leading-tight">
                {manga.title}
              </h1>

              {manga.alternative_titles && (
                <p class="text-ink-400 text-sm mt-2 line-clamp-2">{manga.alternative_titles}</p>
              )}

              <!-- Scanlator Tags -->
              {manga.manga_scanlators.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-4">
                  {manga.manga_scanlators.map((ms) => (
                    <span class="px-3 py-1 bg-ink-800/80 ring-1 ring-ink-700/50 rounded-full text-xs font-medium text-ink-200">
                      {ms.scanlator.name}
                    </span>
                  ))}
                </div>
              )}

              <!-- Stats -->
              <div class="flex gap-8 mt-6">
                <div>
                  <div class="text-2xl font-display font-extrabold text-ink-50">{chapters.length}</div>
                  <div class="text-xs text-ink-400 font-medium mt-0.5">Chapters</div>
                </div>
                <div class="w-px bg-ink-700/60"></div>
                <div>
                  <div class="text-2xl font-display font-extrabold text-crimson-400">{unreadCount}</div>
                  <div class="text-xs text-ink-400 font-medium mt-0.5">Unread</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Scanlator Sources Section -->
        <div class="mb-10">
          <h2 class="text-xl font-display font-extrabold tracking-tight text-ink-50 mb-4">
            Scanlator Sources
            <span class="text-ink-500 text-base font-normal" x-text="`(${sources.length})`"></span>
          </h2>

          <!-- Existing Sources -->
          <div class="space-y-3 mb-6">
            <template x-for="source in sources" :key="source.id">
              <div class="bg-ink-800/30 rounded-xl p-4 ring-1 ring-ink-700/20 hover:ring-ink-600/30 transition-all">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-2">
                      <span class="text-sm font-semibold text-ink-50" x-text="source.scanlator.name"></span>
                      <span class="px-2 py-0.5 bg-ink-700/50 rounded text-xs text-ink-400">Active</span>
                    </div>
                    <a
                      :href="source.scanlator_manga_url"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-xs text-crimson-400 hover:text-crimson-300 hover:underline break-all flex items-center gap-1.5"
                    >
                      <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                      </svg>
                      <span x-text="source.scanlator_manga_url"></span>
                    </a>
                  </div>
                  <button
                    @click="removeSource(source.id)"
                    class="px-3 py-1.5 bg-ink-900/60 hover:bg-crimson-900/40 text-crimson-400 hover:text-crimson-300 rounded-lg text-xs font-semibold transition-all ring-1 ring-ink-700/40 hover:ring-crimson-600/40"
                  >
                    Remove
                  </button>
                </div>
              </div>
            </template>

            <!-- Empty State -->
            <div x-show="sources.length === 0" class="text-center py-12 bg-ink-800/20 rounded-xl ring-1 ring-ink-700/20">
              <svg class="w-12 h-12 mx-auto mb-3 text-ink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
              </svg>
              <p class="text-ink-400 font-medium">No scanlator sources yet</p>
              <p class="text-ink-500 text-sm mt-1">Add a source below to start tracking chapters</p>
            </div>
          </div>

          <!-- Add New Source Form -->
          <div x-show="availableScanlators.length > 0" class="bg-ink-800/20 rounded-xl p-5 ring-1 ring-ink-700/20">
            <h3 class="text-sm font-semibold text-ink-300 mb-4 uppercase tracking-wider">Add New Source</h3>

            <div class="grid md:grid-cols-[1fr,2fr,auto] gap-3">
              <!-- Scanlator Dropdown -->
              <div>
                <label class="block text-xs text-ink-400 font-medium mb-1.5">Scanlator</label>
                <select
                  x-model="newSource.scanlatorId"
                  class="w-full px-3 py-2 bg-ink-900/60 border border-ink-700/40 rounded-lg focus:outline-none focus:ring-2 focus:ring-crimson-600/40 text-ink-50 text-sm"
                >
                  <option value="">Select...</option>
                  <template x-for="scanlator in availableScanlators" :key="scanlator.id">
                    <option :value="scanlator.id" x-text="scanlator.name"></option>
                  </template>
                </select>
              </div>

              <!-- URL Input -->
              <div>
                <label class="block text-xs text-ink-400 font-medium mb-1.5">Manga URL</label>
                <input
                  type="url"
                  x-model="newSource.url"
                  @keydown.enter="addSource()"
                  placeholder="https://..."
                  class="w-full px-3 py-2 bg-ink-900/60 border border-ink-700/40 rounded-lg focus:outline-none focus:ring-2 focus:ring-crimson-600/40 text-ink-50 text-sm placeholder:text-ink-600"
                />
              </div>

              <!-- Add Button -->
              <div class="flex items-end">
                <button
                  @click="addSource()"
                  :disabled="newSource.isSubmitting"
                  :class="{ 'opacity-50 cursor-not-allowed': newSource.isSubmitting }"
                  class="w-full md:w-auto px-6 py-2 bg-crimson-600 hover:bg-crimson-500 disabled:hover:bg-crimson-600 text-white rounded-lg font-semibold text-sm transition-all"
                >
                  <span x-show="!newSource.isSubmitting">Add Source</span>
                  <span x-show="newSource.isSubmitting">Adding...</span>
                </button>
              </div>
            </div>

            <!-- Error Message -->
            <p x-show="newSource.error" x-text="newSource.error" class="mt-3 text-crimson-400 text-xs font-medium"></p>
          </div>

          <!-- All Scanlators Used -->
          <div x-show="availableScanlators.length === 0 && sources.length > 0" class="text-center py-8 bg-ink-800/20 rounded-xl ring-1 ring-ink-700/20">
            <p class="text-ink-400 text-sm">All available scanlators are already added</p>
          </div>
        </div>

        <!-- Chapters Section -->
        <div>
          <h2 class="text-xl font-display font-extrabold tracking-tight text-ink-50 mb-4">Chapters</h2>

          {chapters.length === 0 ? (
            <div class="text-center py-16 text-ink-400 bg-ink-800/20 rounded-xl ring-1 ring-ink-700/20">
              <p class="font-medium">No chapters tracked yet</p>
            </div>
          ) : (
            <div class="bg-ink-800/20 rounded-xl ring-1 ring-ink-700/20 overflow-hidden">
              <ChapterList chapters={chapters} />
            </div>
          )}
        </div>
      </>
    ) : null}
  </div>

</Layout>
