---
import Layout from '../../layouts/Layout.astro';
import ChapterList from '../../components/ChapterList.astro';
import { api } from '../../lib/api';
import { getCoverUrl } from '../../lib/utils';

const { id } = Astro.params;
if (!id) return Astro.redirect('/library');

const mangaId = parseInt(id);
if (isNaN(mangaId)) return Astro.redirect('/library');

let manga = null;
let chapters = [];
let error = null;

try {
  manga = await api.getManga(mangaId);
  chapters = await api.getMangaChapters(mangaId);
} catch (e) {
  console.error('Failed to fetch manga:', e);
  error = e.message;
}

if (!manga && !error) return Astro.redirect('/library');

const unreadCount = chapters.filter(c => !c.read).length;
---

<Layout title={manga ? `${manga.title} - MangaTaro` : 'Error - MangaTaro'}>
  <div class="max-w-5xl mx-auto">
    {error ? (
      <div class="text-center py-24">
        <p class="text-crimson-400 text-lg font-display font-semibold">Failed to load manga</p>
        <p class="text-ink-500 text-sm mt-2">{error}</p>
        <a href="/library" class="text-crimson-400 hover:text-crimson-300 mt-4 inline-block text-sm font-medium">&larr; Back to Library</a>
      </div>
    ) : manga ? (
      <>
        <!-- Back -->
        <a href="/library" class="inline-flex items-center gap-1.5 text-ink-400 hover:text-ink-200 mb-8 text-sm font-medium transition group">
          <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          Library
        </a>

        <!-- Hero Section -->
        <div class="relative rounded-2xl overflow-hidden mb-10">
          <!-- Blurred Background Cover -->
          <div class="absolute inset-0">
            <img
              src={getCoverUrl(manga.cover_filename)}
              alt=""
              class="w-full h-full object-cover blur-3xl scale-125 opacity-15"
            />
            <div class="absolute inset-0 bg-ink-950/60"></div>
          </div>

          <!-- Content -->
          <div class="relative grid md:grid-cols-[200px,1fr] gap-8 p-6 md:p-8">
            <!-- Cover -->
            <div class="mx-auto md:mx-0">
              <img
                src={getCoverUrl(manga.cover_filename)}
                alt={manga.title}
                class="w-44 md:w-full rounded-xl shadow-2xl shadow-ink-950/80 ring-1 ring-ink-50/10"
              />
            </div>

            <!-- Details -->
            <div class="flex flex-col justify-end">
              <p class="text-crimson-400 text-xs font-semibold tracking-widest uppercase mb-2">
                {manga.status.replace('_', ' ')}
              </p>
              <h1 class="text-3xl md:text-4xl font-display font-extrabold tracking-tight text-ink-50 leading-tight">
                {manga.title}
              </h1>

              {manga.alternative_titles && (
                <p class="text-ink-400 text-sm mt-2 line-clamp-2">{manga.alternative_titles}</p>
              )}

              <!-- Scanlator Tags -->
              {manga.manga_scanlators.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-4">
                  {manga.manga_scanlators.map((ms) => (
                    <span class="px-3 py-1 bg-ink-800/80 ring-1 ring-ink-700/50 rounded-full text-xs font-medium text-ink-200">
                      {ms.scanlator.name}
                    </span>
                  ))}
                </div>
              )}

              <!-- Stats -->
              <div class="flex gap-8 mt-6">
                <div>
                  <div class="text-2xl font-display font-extrabold text-ink-50">{chapters.length}</div>
                  <div class="text-xs text-ink-400 font-medium mt-0.5">Chapters</div>
                </div>
                <div class="w-px bg-ink-700/60"></div>
                <div>
                  <div class="text-2xl font-display font-extrabold text-crimson-400">{unreadCount}</div>
                  <div class="text-xs text-ink-400 font-medium mt-0.5">Unread</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chapters Section -->
        <div>
          <h2 class="text-xl font-display font-extrabold tracking-tight text-ink-50 mb-4">Chapters</h2>

          {chapters.length === 0 ? (
            <div class="text-center py-16 text-ink-400 bg-ink-800/20 rounded-xl ring-1 ring-ink-700/20">
              <p class="font-medium">No chapters tracked yet</p>
            </div>
          ) : (
            <div class="bg-ink-800/20 rounded-xl ring-1 ring-ink-700/20 overflow-hidden">
              <ChapterList chapters={chapters} />
            </div>
          )}
        </div>
      </>
    ) : null}
  </div>
</Layout>
